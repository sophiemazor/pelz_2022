<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Replication Experiment Prolific Version</title>

    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-video-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" />

    <style>
        .arrow-button {
            width: 90px;
            cursor: pointer;
            display: block;
            margin: 30px auto;
        }

        .corner-arrow {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 150px;
            cursor: pointer;
        }

        .choice-img {
            width: 200px;
            margin: 20px;
            cursor: pointer;
        }

        .centered {
            text-align: center;
        }

        .main-trial-img {
            width: 600px;
            max-width: 90%;
            display: block;
            margin: 20px auto;
        }

        .choice-img {
            width: 500px;
            margin: 20px;
            cursor: pointer;
        }

        video {
            max-width: 90vw;
            max-height: 80vh;
            width: auto;
            height: auto;
            margin: auto;
            display: block;
        }
    </style>
</head>

<body></body>

<script>
    // Initialize jsPsych
    const jsPsych = initJsPsych({
        on_finish: () => jsPsych.data.displayData()
    });

    // Define files
    const arrow = 'images/next_arrow.png';
    const choices = ['images/training_72White.png', 'images/training_72Black.png'];
    const video_intro_file = 'videos/intro.mp4';
    const video_character_intro_file = 'videos/character_intro.mp4';
    const catch_trial_images = ['images/catch_left.png', 'images/catch_right.png'];

    // capture info from Prolific
// capture info from Prolific
  //var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID'); do not capture prolific PID yet
 var prolific_id = jsPsych.data.getURLVariable('PROLIFIC_PID') || null;
 var study_id = jsPsych.data.getURLVariable('STUDY_ID') || null;
 var session_id = jsPsych.data.getURLVariable('SESSION_ID') || null;
 var subject_id = jsPsych.randomization.randomID(10);
 var prolific_id_last4 = prolific_id ? prolific_id.slice(-4) : "NA";
    
  jsPsych.data.addProperties({
   prolific_id_last4: prolific_id_last4,
   study_id: study_id,
   session_id: session_id
 });

    const filename = `${subject_id}.csv`;


    // Map each test image to its prompt
    const trial_prompts = [
        { img: "images/90_10_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Mary’s box?" },
        { img: "images/51_49_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Mary’s box?" },
        { img: "images/55_45_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Sam’s box?" },
        { img: "images/80_20_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Sam’s box?" },
        { img: "images/75_25_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Nancy’s box?" },
        { img: "images/65_35_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Nancy’s box?" },
        { img: "images/70_30_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Jake’s box?" },
        { img: "images/60_40_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Jake’s box?" },
        { img: "images/85_15_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Amy’s box?" },
        { img: "images/95_5_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Amy’s box?" },
    ];

    // Randomize order
    const randomized_trials = jsPsych.randomization.shuffle(trial_prompts);

    // Initialize timeline
    const timeline = [];

    // PRELOAD
    const preload = {
        type: jsPsychPreload,
        images: [arrow, ...choices, ...catch_trial_images, ...trial_prompts.map(t => t.img)],
        video: [video_intro_file, video_character_intro_file]
    };
    timeline.push(preload);

    // consent screen
    const consent = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
      <div style="max-width: 8.5in; margin: 0 auto; text-align: left;">

        <h2>Consent Form</h2>
        <p>Please read the consent form carefully before proceeding.</p>
        <p>You are being invited to participate in a research study titled “Reproducibility of Psychological Science and Instruction.” This study is being done by Dr. Bria Long from UC San Diego and associated graduate students in Experimental Methods course. You were selected to participate in this study because you are an adult in the U.S. and have been a represented population in previous psychology studies. </p>
        <p>The purpose of this study is to better understand how well previously published studies in the psychological field replicate online and with different populations. Your participation in this research should last approximately 5-30 minutes  If you agree to take part in this study, you may be asked to view a set of stimuli, including pictures, sounds, written text, or videos and then giving some responses via key-presses, verbally, or with paper-and-pencil. We may also observe your choices or preferences among an array of stimuli.  These stimuli will be taken directly from or closely adapted from studies that already exist in the published psychological literature. Stimuli will include, e.g., pictures of objects and human faces, audio and video clips, short text passages, etc. None of the stimuli will be disturbing, threatening, or offensive. The online and in-person experiments described in this protocol will take no more than 30 minutes. An example game you might play would be to click on an image on the screen that matches a word you hear being said out loud. Your total expected time commitment for this study is between 5-30 minutes, and is specified in the study description.</p>
        <p>Your participation in this study is completely voluntary and you can withdraw at any time. Choosing not to participate or withdrawing will result in no penalty or loss of benefits to which you are entitled. You are free to skip any question that you choose.</p>
        <p> We will not be asking for any personally identifying information, and we will handle responses as confidentially as possible. Your Prolific IDs will never be tied to your responses on this survey. However, we cannot guarantee the confidentiality of information transmitted over the Internet. To minimize this risk, data containing anything that might be personally identifiable (e.g. Prolific IDs or IP addresses) will be encrypted on transfer and storage and will only be accessible to qualified lab personnel. We will be keeping data collected as part of this experiment indefinitely. This anonymized data (containing neither Prolific IDs nor IP addresses) may be shared with the scientific community or with other participants to be used as stimuli in future studies.</p>
        
        <p>If you have questions about this project or if you have a research-related problem, you may contact the researcher(s),  Sophie Mazor, smazor@ucsd.edu or Dr. Bria Long, brlong@ucsd.edu. If you have any questions concerning your rights as a research subject, you may contact the UC San Diego Office of IRB Administration at irb@ucsd.edu or 858-246-4777.</p>
        
        <p> By participating in this research you are indicating that you are at least 18 years old, have read this consent form, and agree to participate in this research study. Please keep this consent form for your records.</p>
        <p>By clicking "Agree", you agree to participate in this study.</p>
        </div>
    `,
        choices: ["Agree"],
        on_finish: data => {
            data.consent = "Agree";
        }
    };
    timeline.push(consent);

    // WELCOME SCREEN
    const welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
      <div class="centered">
        <p>Welcome!</p>
        <p>First, please ensure your volume is turned on.</p> 
        <p>Then, click the arrow in the corner of the screen to get started.</p>
        <img src="${arrow}" class="corner-arrow" id="start-arrow">
      </div>
    `,
        choices: "NO_KEYS",
        on_load: () => {
            document.getElementById('start-arrow').addEventListener('click', () => {
                jsPsych.finishTrial();
            });
        }
    };
    timeline.push(welcome);

    // INTRO VIDEO TRIAL
    const video_intro_trial = {
        type: jsPsychVideoKeyboardResponse,
        stimulus: [video_intro_file],
        choices: "NO_KEYS",
        trial_ends_after_video: false,
        render_on_canvas: false,
        on_load: () => {
            const videoEl = document.querySelector('video');

            // When video finishes, show arrow
            videoEl.addEventListener('ended', () => {
                const arrowImg = document.createElement('img');
                arrowImg.src = arrow; // same arrow as welcome screen
                arrowImg.classList.add('corner-arrow');
                arrowImg.id = 'start-arrow';
                document.body.appendChild(arrowImg);

                // Click arrow to view attention check
                arrowImg.addEventListener('click', () => {
                    jsPsych.finishTrial();
                });
            });
        },

        on_finish: () => {
            // Clean up arrow so it doesn’t carry over to the next trial
            const existingArrow = document.getElementById('start-arrow');
            if (existingArrow) existingArrow.remove();
        }
    };
    timeline.push(video_intro_trial);

    // ATTENTION CHECK ANSWER CHOICES
    const answer_choices = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>Please select the box you think the samples in the bowl came from:</p>",
        choices: ["72White", "72Black"],
        button_html: (choice, index) => {
            return `<button class="jspsych-btn" style="border:none; background:none;">
              <img src="${choices[index]}" class="choice-img">
            </button>`;
        },
        on_finish: data => {
            const labels = ["72White", "72Black"];
            data.attention_check = labels[data.response];
        }
    };
    timeline.push(answer_choices);

    // INTRO TO CHARACTERS VIDEO TRIAL
    const video_character_intro_trial = {
        type: jsPsychVideoKeyboardResponse,
        stimulus: [video_character_intro_file],
        choices: "NO_KEYS",
        trial_ends_after_video: false,
        render_on_canvas: false,
        on_load: () => {
            const videoEl = document.querySelector('video');

            // When video finishes, show arrow
            videoEl.addEventListener('ended', () => {
                const arrowImg = document.createElement('img');
                arrowImg.src = arrow; // same arrow as welcome screen
                arrowImg.classList.add('corner-arrow');
                arrowImg.id = 'start-arrow';
                document.body.appendChild(arrowImg);

                // arrow to view attention check
                arrowImg.addEventListener('click', () => {
                    jsPsych.finishTrial();
                });
            });
        },

        on_finish: () => {
            // get rid of the arrow so it doesn’t carry over to the next trial
            const existingArrow = document.getElementById('start-arrow');
            if (existingArrow) existingArrow.remove();
        }
    };
    timeline.push(video_character_intro_trial);

    // CATCH TRIAL FUNCTION
    const catch_trial = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>If you're paying attention, click on the box on the right</p>",
        choices: catch_trial_images,
        button_html: (choice, index) => {
            return `<button class="jspsych-btn" style="border:none; background:none;">
              <img src="${choice}" class="choice-img">
            </button>`;
        },
        on_finish: data => {
            const labels = ["wrong", "correct"];
            data.catch_trial = labels[data.response];
        }
    };
    timeline.push(catch_trial);

    // TEST TRIAL FUNCTION
    const main_trial = (img_path, prompt_text) => ({
        timeline: [
            {
                type: jsPsychSurveyText,
                preamble: `<div style="max-width"; 8.5in; margin: 0 auto; text-align: left;" ><img src="${img_path}" width="1000"></div>`,
                questions: [
                    {
                        prompt: prompt_text,
                        placeholder: "Enter a number...",
                        rows: 1,
                        columns: 20
                    }
                ],
                button_label: "Continue",
                // Validate input before allowing the trial to finish.
                on_load: () => {
                    const display = jsPsych.getDisplayElement();
                    const form = display.querySelector('form');

                    // helper to ensure an inline validation message exists
                    function getValidationNode() {
                        let node = display.querySelector('.validation-msg');
                        if (!node) {
                            node = document.createElement('div');
                            node.className = 'validation-msg';
                            node.style.color = 'red';
                            node.style.textAlign = 'center';
                            node.style.marginTop = '8px';

                            const questionBlock = display.querySelector('.jspsych-survey-text-question');
                            if (questionBlock) questionBlock.appendChild(node);
                            else display.appendChild(node);
                        }
                        return node;
                    }

                    if (form) {
                        // only allow form submission if input is valid
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            e.stopImmediatePropagation();

                            const input = display.querySelector('input[type="text"], textarea');
                            const val = input ? input.value.trim() : '';
                            const msgNode = getValidationNode();
                            const numeric = Number(val);

                            // if it's empty
                            if (val === '') {
                                msgNode.textContent = 'please enter a numerical value';
                                if (input) input.focus();
                                return false;
                            }

                            // if it's not a number
                            if (isNaN(numeric)) {
                                msgNode.textContent = 'please enter a numerical value';
                                if (input) input.focus();
                                return false;
                            }

                            // if it's a negative number
                            if (numeric < 0) {
                                msgNode.textContent = 'please enter in a positive number';
                                if (input) input.focus();
                                return false;
                            }

                            // as long as value is numeric and non-negative, finish the trial and save
                            const raw = val;
                            const numericParsed = parseFloat(raw);

                            // make a trial_name from the filename
                            let base;
                            try {
                                const file = img_path.split('/').pop().replace(/\.png$/i, '');
                                base = file.replace(/_test$/i, '').replace(/-test$/i, '').replace(/[^A-Za-z0-9]+/g, '_');
                                base = base.replace(/^_+|_+$/g, '');
                            } catch (e) {
                                base = img_path;
                            }

                            jsPsych.finishTrial({
                                response: { Q0: raw },
                                responses: JSON.stringify({ Q0: raw }),
                                trial_image: img_path,
                                trial_name: base,
                                samples_requested: Number.isFinite(numericParsed) ? numericParsed : raw
                            });
                        }, true);
                    }
                }
            }
        ]
    });

    // RANDOMIZE THE TEST TRIALS
    randomized_trials.forEach(t => timeline.push(main_trial(t.img, t.prompt)));

    // strategy question — require a non-empty response
    const strategy_question = {
        type: jsPsychSurveyText,
        preamble: "<p>Thanks! Lastly, please describe the strategy you used to decide how many balls I needed to put in the bowl:</p>",
        questions: [
            {
                prompt: "Your answer:",
                rows: 5,
                columns: 40
            }
        ],
        button_label: "Continue",
        // Intercept submit to require a non-empty strategy description.
        on_load: () => {
            const display = jsPsych.getDisplayElement();
            const form = display.querySelector('form');

            function getValidationNode() {
                let node = display.querySelector('.validation-msg');
                if (!node) {
                    node = document.createElement('div');
                    node.className = 'validation-msg';
                    node.style.color = 'red';
                    node.style.textAlign = 'center';
                    node.style.marginTop = '8px';
                    const questionBlock = display.querySelector('.jspsych-survey-text-question');
                    if (questionBlock) questionBlock.appendChild(node);
                    else display.appendChild(node);
                }
                return node;
            }

            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    e.stopImmediatePropagation();

                    const input = display.querySelector('textarea, input[type="text"]');
                    const val = input ? input.value.trim() : '';
                    const msgNode = getValidationNode();

                    if (val === '') {
                        msgNode.textContent = 'please enter a response before continuing';
                        if (input) input.focus();
                        return false;
                    }

                    // valid — finish trial and save strategy
                    const raw = val;
                    jsPsych.finishTrial({
                        response: { Q0: raw },
                        responses: JSON.stringify({ Q0: raw }),
                        strategy: raw
                    });
                }, true);
            }
        }
    };
    timeline.push(strategy_question);


    // feedback question — require a non-empty response
    const feedback_question = {
        type: jsPsychSurveyText,
        preamble: "<p>If you have any feedback about this experiment, please share it below:</p>",
        questions: [
            {
                prompt: "Your feedback:",
                rows: 5,
                columns: 40
            }
        ],
        button_label: "Finish",
        // Intercept submit to require a non-empty response. If empty, show inline message.
        on_load: () => {
            const display = jsPsych.getDisplayElement();
            const form = display.querySelector('form');

            function getValidationNode() {
                let node = display.querySelector('.validation-msg');
                if (!node) {
                    node = document.createElement('div');
                    node.className = 'validation-msg';
                    node.style.color = 'red';
                    node.style.textAlign = 'center';
                    node.style.marginTop = '8px';
                    const questionBlock = display.querySelector('.jspsych-survey-text-question');
                    if (questionBlock) questionBlock.appendChild(node);
                    else display.appendChild(node);
                }
                return node;
            }

            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    e.stopImmediatePropagation();

                    const input = display.querySelector('textarea, input[type="text"]');
                    const val = input ? input.value.trim() : '';
                    const msgNode = getValidationNode();

                    if (val === '') {
                        msgNode.textContent = 'please enter a response before continuing';
                        if (input) input.focus();
                        return false;
                    }

                    // valid — finish trial with feedback saved
                    const raw = val;
                    jsPsych.finishTrial({
                        response: { Q0: raw },
                        responses: JSON.stringify({ Q0: raw }),
                        feedback: raw
                    });
                }, true);
            }
        }
    };
    timeline.push(feedback_question);

    const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "9AmGr41c9Dg7",
        stimulus: "Saving Data. Please do not close this window.",
        filename: filename,
        data_string: () => jsPsych.data.get().csv()
    };
    timeline.push(save_data);

    // debrief screen
    const debrief = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
        <div style="max-width: 8.5in; margin: 0 auto; text-align: left;">
        <h2>Thank you for participating!</h2>
        <p>This experiment examines whether adults adjust their sampling behavior depending on the difficulty of a problem. Are adults sensitive to the fact that easier problems may require less information, compared to harder problems?</p>
        <p>Please do not share specific details of this experiment with others.</p>
        <p>Click the arrow in the corner to finish the experiment.</p>
        <img src="${arrow}" class="corner-arrow" id="end-arrow">
      </div>
    `,
        choices: "NO_KEYS",
        on_load: () => {
            document.getElementById('end-arrow').addEventListener('click', () => {
                jsPsych.finishTrial();
            });
        }
    };
    timeline.push(debrief);

    // END SCREEN
    const end_screen = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>You've finished the task. Thanks for participating!</p>
    <p><a href= "https://app.prolific.com/submissions/complete?cc=C1NFIWT9" >Click here to return to Prolific and complete the study</a>.</p>`,
        choices: "NO_KEYS"
    };


    timeline.push(end_screen);

    // RUN EXPERIMENT
    jsPsych.run(timeline);
</script>

</html>

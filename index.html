<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Replication Experiment</title>

    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-video-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script
        src="https://github.com/jspsych/jspsych-contrib/blob/main/packages/plugin-pipe/docs/jspsych-pipe.md"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" />

    <style>
        .arrow-button {
            width: 90px;
            cursor: pointer;
            display: block;
            margin: 30px auto;
        }

        .corner-arrow {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 150px;
            cursor: pointer;
        }

        .choice-img {
            width: 200px;
            margin: 20px;
            cursor: pointer;
        }

        .centered {
            text-align: center;
        }

        .main-trial-img {
            width: 600px;
            max-width: 90%;
            display: block;
            margin: 20px auto;
        }

        .choice-img {
            width: 500px;
            margin: 20px;
            cursor: pointer;
        }

        video {
            max-width: 90vw;
            max-height: 80vh;
            width: auto;
            height: auto;
            margin: auto;
            display: block;
        }
    </style>
</head>

<body></body>

<script>
    // Initialize jsPsych
    const jsPsych = initJsPsych({
        on_finish: () => jsPsych.data.displayData()
    });

    // Define files
    const arrow = 'images/next_arrow.png';
    const choices = ['images/training_72White.png', 'images/training_72Black.png'];
    const video_intro_file = 'videos/intro.mp4';
    const video_character_intro_file = 'videos/character_intro.mp4';


    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;


    // Map each test image to its prompt
    const trial_prompts = [
        { img: "images/90_10_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Mary’s box?" },
        { img: "images/51_49_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Mary’s box?" },
        { img: "images/55_45_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Sam’s box?" },
        { img: "images/80_20_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Sam’s box?" },
        { img: "images/75_25_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Nancy’s box?" },
        { img: "images/65_35_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Nancy’s box?" },
        { img: "images/70_30_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Jake’s box?" },
        { img: "images/60_40_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Jake’s box?" },
        { img: "images/85_15_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Amy’s box?" },
        { img: "images/95_5_test.png", prompt: "How many balls do you think I need to put in the bowl for you to know whether the balls came from my box or Amy’s box?" }
    ];

    // Randomize order
    const randomized_trials = jsPsych.randomization.shuffle(trial_prompts);

    // Initialize timeline
    const timeline = [];

    // PRELOAD
    const preload = {
        type: jsPsychPreload,
        images: [arrow, ...choices, ...trial_prompts.map(t => t.img)],
        video: [video_intro_file, video_character_intro_file]
    };
    timeline.push(preload);

    // WELCOME SCREEN
    const welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
      <div class="centered">
        <p>Welcome!</p>
        <p>First, please ensure your volume is turned on.</p> 
        <p>Then, click the arrow in the corner of the screen to get started.</p>
        <img src="${arrow}" class="corner-arrow" id="start-arrow">
      </div>
    `,
        choices: "NO_KEYS",
        on_load: () => {
            document.getElementById('start-arrow').addEventListener('click', () => {
                jsPsych.finishTrial();
            });
        }
    };
    timeline.push(welcome);

    // INTRO VIDEO TRIAL
    const video_intro_trial = {
        type: jsPsychVideoKeyboardResponse,
        stimulus: [video_intro_file],
        choices: "NO_KEYS",
        trial_ends_after_video: false,
        render_on_canvas: false,
        on_load: () => {
            const videoEl = document.querySelector('video');

            // When video finishes, show arrow
            videoEl.addEventListener('ended', () => {
                const arrowImg = document.createElement('img');
                arrowImg.src = arrow; // same arrow as welcome screen
                arrowImg.classList.add('corner-arrow');
                arrowImg.id = 'start-arrow';
                document.body.appendChild(arrowImg);

                // Click arrow to view attention check
                arrowImg.addEventListener('click', () => {
                    jsPsych.finishTrial();
                });
            });
        },

        on_finish: () => {
            // Clean up arrow so it doesn’t carry over to the next trial
            const existingArrow = document.getElementById('start-arrow');
            if (existingArrow) existingArrow.remove();
        }
    };

    timeline.push(video_intro_trial);

    // ATTENTION CHECK ANSWER CHOICES
    const answer_choices = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>Please select the box you think the samples in the bowl came from:</p>",
        choices: ["72White", "72Black"],
        button_html: (choice, index) => {
            return `<button class="jspsych-btn" style="border:none; background:none;">
              <img src="${choices[index]}" class="choice-img">
            </button>`;
        },
        on_finish: data => {
            data.selected_box = choices[data.response];
        }
    };
    timeline.push(answer_choices);

    // INTRO TO CHARACTERS VIDEO TRIAL
    const video_character_intro_trial = {
        type: jsPsychVideoKeyboardResponse,
        stimulus: [video_character_intro_file],
        choices: "NO_KEYS",
        trial_ends_after_video: false,
        render_on_canvas: false,
        on_load: () => {
            const videoEl = document.querySelector('video');

            // When video finishes, show arrow
            videoEl.addEventListener('ended', () => {
                const arrowImg = document.createElement('img');
                arrowImg.src = arrow; // same arrow as welcome screen
                arrowImg.classList.add('corner-arrow');
                arrowImg.id = 'start-arrow';
                document.body.appendChild(arrowImg);

                // arrow to view attention check
                arrowImg.addEventListener('click', () => {
                    jsPsych.finishTrial();
                });
            });
        },

        on_finish: () => {
            // get rid of the arrow so it doesn’t carry over to the next trial
            const existingArrow = document.getElementById('start-arrow');
            if (existingArrow) existingArrow.remove();
        }
    };

    timeline.push(video_character_intro_trial);

    // TEST TRIAL FUNCTION
    const main_trial = (img_path, prompt_text) => ({
        timeline: [
            {
                type: jsPsychSurveyText,
                preamble: `<div class="centered"><img src="${img_path}" width="1000"></div>`,
                questions: [
                    {
                        prompt: prompt_text,
                        placeholder: "Enter a number...",
                        rows: 1,
                        columns: 20
                    }
                ],
                button_label: "Continue",
                on_finish: data => {
                    data.trial_image = img_path;
                    data.prompt_used = prompt_text;
                }
            }
        ]
    });


    // RANDOMIZE THE TEST TRIALS
    randomized_trials.forEach(t => timeline.push(main_trial(t.img, t.prompt)));

    const strategy_question = {
        type: jsPsychSurveyText,
        preamble: "<p>Thanks! Lastly, please describe the strategy you used to decide how many balls I needed to put in the bowl:</p>",
        questions: [
            {
                prompt: "Your answer:",
                rows: 5,
                columns: 40
            }
        ],
        button_label: "Continue"
    };
    timeline.push(strategy_question);

    const feedback_question
        = {
        type: jsPsychSurveyText,
        preamble: "<p>If you have any feedback about this experiment, please share it below:</p>",
        questions: [
            {
                prompt: "Your feedback:",
                rows: 5,
                columns: 40
            }
        ],
        button_label: "Finish"
    };
    timeline.push(feedback_question);


    const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "9AmGr41c9Dg7",
        filename: filename,
        data_string: () => {
            const subj_id = subject_id;

            // save attention check question to datasheet
            const attn_data = jsPsych.data.get().filter({
                trial_type: 'html-button-response'
            }).values()[0];
            const attention_check = attn_data ? attn_data.selected_box.split('/').pop().replace('.png', '') : '';

            // save test trial data
            const test_data = jsPsych.data.get().filter({
                trial_type: 'survey-text'
            }).filterCustom(d => d.trial_image && d.prompt_used);

            // put data in long format
            const long_data = test_data.map(d => {
                const response = JSON.parse(d.responses);
                const samples_taken = response.Q0 ? response.Q0.trim() : '';
                return {
                    subject_id: subj_id,
                    test_trial: d.trial_image.split('/').pop().replace('.png', ''),
                    samples_taken: samples_taken,
                    attention_check: attention_check
                };
            });

            // --- 4. Convert to CSV ---
            const header = "subject_id,test_trial,samples_taken,attention_check\n";
            const rows = long_data.map(r =>
                `${r.subject_id},${r.test_trial},${r.samples_taken},${r.attention_check}`
            ).join("\n");

            const csv = header + rows;

            return csv;
        }
    };

    timeline.push(save_data);

    // RUN EXPERIMENT
    jsPsych.run(timeline);
</script>

</html>